<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gateway Solver | Premium Captcha Solving</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=JetBrains+Mono&display=swap"
        rel="stylesheet">
</head>

<body>
    <div class="blob-bg"></div>
    <div class="container">
        <header>
            <div class="logo">
                <span class="logo-icon">âš¡</span>
                <h1>GATEWAY<span>SOLVER</span></h1>
            </div>
            <div class="status-badge" id="api-status">
                <span class="status-dot"></span> API ONLINE
            </div>
        </header>

        <main class="glass-card">
            <div class="card-header">
                <h2>API Access Management</h2>
                <p>Enter your premium or free key to begin solving.</p>
            </div>

            <div class="input-section">
                <div class="input-group">
                    <label for="api-key">API KEY</label>
                    <div class="input-wrapper">
                        <input type="password" id="api-key" placeholder="Enter your key here..."
                            value="{{ api_key or '' }}">
                        <button id="save-key" class="btn-primary">SAVE</button>
                        <button id="clear-key" class="btn-outline">CLEAR</button>
                    </div>
                </div>
            </div>

            <div class="info-grid">
                <div class="info-card">
                    <h3>TIER</h3>
                    <div class="value" id="key-tier">UNKNOWN</div>
                </div>
                <div class="info-card">
                    <h3>HWID LOCK</h3>
                    <div class="value" id="hwid-status">INACTIVE</div>
                </div>
            </div>

            <div class="usage-preview">
                <h3>USAGE DOCS</h3>
                <div class="code-block">
                    <pre><code id="usage-code">GET /solve?key=YOUR_KEY</code></pre>
                </div>
                <p class="hint" id="delay-hint">Free keys have a 3-4s delay. Upgrade for instant results.</p>
            </div>
        </main>

        <!-- ADMIN DASHBOARD (Hidden by default) -->
        <div id="admin-section" class="glass-card full-width" style="display: none; margin-top: 2rem;">
            <div class="card-header">
                <h2>ADMIN DASHBOARD</h2>
                <p>Manage API Keys & Access</p>
            </div>

            <div class="admin-controls">
                <div class="create-key-panel">
                    <h3>Create Key</h3>
                    <div class="input-group-row">
                        <select id="new-key-type" class="select-input">
                            <option value="free">Free Tier</option>
                            <option value="paid">Paid Tier</option>
                        </select>
                        <input type="number" id="new-key-expiry" placeholder="Days (Empty = Forever)"
                            class="text-input">
                        <button id="create-key-btn" class="btn-primary">GENERATE</button>
                    </div>
                    <div id="new-key-result" class="result-box"></div>
                </div>
            </div>

            <div class="keys-table-wrapper">
                <h3>Active Keys</h3>
                <table class="keys-table">
                    <thead>
                        <tr>
                            <th>Key</th>
                            <th>Type</th>
                            <th>Uses</th>
                            <th>HWID</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="admin-key-list">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <footer>
            <p>&copy; 2026 Gateway Solver. All rights reserved.</p>
        </footer>
    </div>

    <script>
        const saveBtn = document.getElementById('save-key');
        const clearBtn = document.getElementById('clear-key');
        const keyInput = document.getElementById('api-key');
        const tierDisplay = document.getElementById('key-tier');
        const hwidDisplay = document.getElementById('hwid-status');
        const usageCode = document.getElementById('usage-code');
        const delayHint = document.getElementById('delay-hint');

        // Admin Elements
        const adminSection = document.getElementById('admin-section');
        const adminKeyList = document.getElementById('admin-key-list');
        const createKeyBtn = document.getElementById('create-key-btn');
        const newKeyType = document.getElementById('new-key-type');
        const newKeyExpiry = document.getElementById('new-key-expiry');
        const newKeyResult = document.getElementById('new-key-result');

        function setCookie(name, value, days) {
            let expires = "";
            if (days) {
                let date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + (value || "") + expires + "; path=/";
        }

        function getCookie(name) {
            let nameEQ = name + "=";
            let ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) == ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        saveBtn.addEventListener('click', () => {
            const key = keyInput.value.trim();
            if (key) {
                setCookie('api_key', key, 30);
                location.reload();
            }
        });

        clearBtn.addEventListener('click', () => {
            setCookie('api_key', '', -1);
            location.reload();
        });

        // Admin Functions
        async function loadAdminDashboard(secret) {
            try {
                const r = await fetch('/admin/keys', {
                    headers: { 'Admin-Secret': secret }
                });
                if (r.status === 401) return; // Not admin

                const keys = await r.json();

                // Show Admin Section
                if (adminSection) adminSection.style.display = 'block';

                renderKeysTable(keys, secret);

            } catch (e) {
                console.error("Admin check failed", e);
            }
        }

        function renderKeysTable(keys, secret) {
            if (!adminKeyList) return;
            adminKeyList.innerHTML = '';

            Object.entries(keys).forEach(([key, data]) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="mono">${key}</td>
                    <td><span class="badge ${data.type}">${data.type.toUpperCase()}</span></td>
                    <td>${data.uses || 0}</td>
                    <td>
                        <span class="${data.hwid ? 'status-locked' : 'status-unlocked'}">
                            ${data.hwid ? 'LOCKED' : 'UNLOCKED'}
                        </span>
                    </td>
                    <td>
                        <button onclick="resetHWID('${key}', '${secret}')" class="btn-xs btn-outline">RESET HWID</button>
                        <button onclick="deleteKey('${key}', '${secret}')" class="btn-xs btn-danger">DELETE</button>
                    </td>
                `;
                adminKeyList.appendChild(tr);
            });
        }

        window.resetHWID = async (key, secret) => {
            if (!confirm('Reset HWID for this key?')) return;
            const r = await fetch('/admin/keys/reset_hwid', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Admin-Secret': secret },
                body: JSON.stringify({ key })
            });
            const data = await r.json();
            if (data.success) {
                alert('HWID Reset!');
                loadAdminDashboard(secret);
            } else {
                alert('Error: ' + data.error);
            }
        };

        window.deleteKey = async (key, secret) => {
            if (!confirm('Delete this key permanently?')) return;
            const r = await fetch('/admin/keys/delete', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json', 'Admin-Secret': secret },
                body: JSON.stringify({ key })
            });
            const data = await r.json();
            if (data.success) {
                loadAdminDashboard(secret);
            } else {
                alert('Error: ' + data.error);
            }
        };

        if (createKeyBtn) {
            createKeyBtn.addEventListener('click', async () => {
                const secret = getCookie('api_key');
                const type = newKeyType.value;
                const expiry = newKeyExpiry.value ? parseInt(newKeyExpiry.value) * 86400 : null; // days to seconds

                const r = await fetch('/admin/keys/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Admin-Secret': secret },
                    body: JSON.stringify({ type, expires_in: expiry })
                });
                const data = await r.json();
                if (data.success) {
                    newKeyResult.innerHTML = `Created: <span class="mono">${data.key}</span>`;
                    loadAdminDashboard(secret);
                }
            });
        }

        // Simple check to show current key status if present
        const currentKey = getCookie('api_key');
        if (currentKey) {
            usageCode.innerText = `GET /solve?key=${currentKey}`;

            // Try Admin Load
            loadAdminDashboard(currentKey);

            fetch('/validate')
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        tierDisplay.innerText = data.type.toUpperCase();
                        tierDisplay.className = 'value ' + data.type;
                        hwidDisplay.innerText = data.hwid_locked ? 'LOCKED' : 'NOT LOCKED';
                        hwidDisplay.className = 'value ' + (data.hwid_locked ? 'locked' : 'unlocked');

                        if (data.type === 'paid') {
                            delayHint.innerText = 'Paid key detected. 0ms artificial delay.';
                            delayHint.style.color = 'var(--success)';
                        }
                    } else {
                        tierDisplay.innerText = 'INVALID';
                        tierDisplay.style.color = '#ef4444';
                    }
                })
                .catch(err => {
                    console.error('Validation failed:', err);
                });
        }
    </script>
</body>

</html>